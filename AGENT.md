# sigscope AI Agent Guide

VCD波形データをAI/LLMが取得するためのコマンドラインインターフェース

## 概要

sigscopeは、VCD (Value Change Dump) ファイルから波形データを抽出し、JSON形式で出力するツールです。

## コマンド

### `list` - 信号リスト取得

全信号のメタデータを取得します。

```bash
sigscope list <vcd-file>
```

**出力:**
```json
{
  "signals": [
    {"name": "TOP.module.signal_name", "width": 8},
    {"name": "TOP.module.clk", "width": 1}
  ],
  "timescale": "1ps",
  "time_range": [0, 1000000]
}
```

**フィールド:**
- `signals[]`: 全信号のリスト
  - `name`: 階層的な完全信号名
  - `width`: ビット幅
- `timescale`: VCDファイルのタイムスケール
- `time_range`: [開始時刻, 終了時刻]

### `query` - 波形データ取得

時系列差分イベント形式で波形データを出力します。

```bash
sigscope query [OPTIONS] <vcd-file>
```

**オプション:**
- `-s, --signals <pattern>`: 信号名パターン（部分一致、繰り返し可能）
- `-t, --time-start <time>`: 開始時刻（デフォルト: 0）
- `-e, --time-end <time>`: 終了時刻（デフォルト: VCD終了時刻）

**出力（コンパクトJSON）:**
```json
{
  "timescale": "1ps",
  "defs": {
    "clk": {"w": 1},
    "data": {"w": 8, "radix": "hex"},
    "state": {"w": 2, "radix": "bin"}
  },
  "clock": {
    "name": "clk",
    "period": 10000,
    "edge": "posedge"
  },
  "init": {
    "clk": "0",
    "data": "0",
    "state": "00"
  },
  "events": [
    {"t": 15000, "set": {"rst_n": "1", "state": "01"}},
    {"t": 25000, "set": {"data": "2A", "valid": "1"}},
    {"t": 35000, "set": {"state": "10"}}
  ]
}
```

## 出力構造

### `timescale`

VCDファイルのタイムスケール文字列（例: `"1ps"`, `"1ns"`）

### `defs` - 信号定義

各信号のメタデータ。

- `w`: ビット幅
- `radix`: 基数（複数bit信号のみ）
  - `"hex"`: 16進数（x/z未使用）
  - `"bin"`: 2進数（x/z使用）

**重要:** `init`と`events`の値は、この`radix`に従った形式で記録されています。

### `clock` - クロック情報

自動検出されたクロック信号の情報（検出できない場合は`null`）。

- `name`: 信号名（短縮形）
- `period`: 周期（タイムスケール単位）
- `edge`: `"posedge"` または `"negedge"`

**重要:** クロック信号は`events`から除外されています。

**検出条件:**
- 1bit信号
- 周期的な0/1遷移
- 最低3回の遷移
- 遷移間隔の2/3以上が一致

### `init` - 初期値

開始時刻における各信号の値。

**値の形式:**
- 1bit: `"0"`, `"1"`, `"x"`, `"z"`
- 複数bit（hex）: `"2A"`, `"FF"`, `"0"`
- 複数bit（bin）: `"00101010"`, `"xxxx1010"`

### `events` - 差分イベント列

時刻順の変化イベント。**変化した信号のみ**記録。

- `t`: 時刻（タイムスケール単位）
- `set`: 変化した信号と新しい値のマップ

**特性:**
- 同じ時刻の複数変化は1イベントにまとめられる
- クロック信号の変化は含まれない
- 時間範囲（`-t`～`-e`）外は除外される

## 信号名の短縮

`query`出力では、階層名の最後の要素のみ使用。

- `list`出力: `TOP.udp_rx_tb.rst_n`
- `query`出力: `rst_n`

**注意:** 短縮名が衝突する可能性があります。

## 基本フロー

1. `sigscope list <vcd-file>` で全信号リスト取得
2. 必要な信号を特定
3. `sigscope query -s <pattern> <vcd-file>` で波形データ取得
4. JSON出力を使用

## コマンド例

```bash
# 全信号の波形データ
sigscope query waveform.vcd

# 特定信号のみ（部分一致）
sigscope query -s clk -s data waveform.vcd

# 時間範囲指定
sigscope query -t 1000 -e 5000 waveform.vcd

# 組み合わせ
sigscope query -s "udp_rx" -t 1000 -e 10000 waveform.vcd
```

## ユースケース

### デバッグ支援
- 特定信号の異常値検出
- 信号間のタイミング関係検証
- 予期しない状態遷移の特定

### タイミング解析
- イベント間の時間差計算
- セットアップ/ホールド時間検証
- クロック周期との相対的タイミング

### 状態機械解析
- 状態信号の遷移パターン抽出
- 状態遷移図の生成
- 不正な状態遷移検出

### プロトコル解析
- データバス通信パターン検証
- ハンドシェイク信号タイミング確認
- パケット構造解析

### 異常検出
- 信号値の範囲チェック
- 予期しないタイミングでの変化
- 不定値（x）や高インピーダンス（z）検出

## エラー

コマンド失敗時は標準エラー出力にメッセージ出力、終了コード≠0。

```
Error: failed to parse VCD file: ...
Error: invalid time range: start (5000) > end (1000)
```

**データが空:**
- 信号が見つからない → `events`配列が空
- クロック検出失敗 → `clock`が`null`
- 時間範囲外 → `events`配列が空

## 制約

- 出力はコンパクトJSON（改行・インデントなし）
- 大規模VCDファイル（数GB以上）は処理時間がかかる
- 信号名の短縮により同名衝突の可能性
- メモリ使用量はVCDファイルサイズに比例

## トラブルシューティング

### クロックが検出されない

**原因:**
- 周期的遷移が不十分（3回未満）
- 遷移間隔のばらつき（2/3未満が一致）
- 複数bit信号（1bitのみ対象）

**対処:**
- `list`で1bit信号確認
- `-t`/`-e`で十分な時間範囲指定

### 信号が見つからない

**原因:**
- `-s`パターンが部分一致しない

**対処:**
- `list`で正確な信号名確認
- パターンを緩和

### 時間範囲エラー

**原因:**
- 開始時刻 > 終了時刻

**対処:**
- `list`で有効な`time_range`確認
- `-t`/`-e`の値調整
